<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cassio</title>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f9f9f7;
  --surface: #ffffff;
  --noir: #111111;
  --fort: #2a2a2a;
  --gris: #5a5a5a;
  --doux: #8a8a8a;
  --leger: #d8d8d4;
  --border: #e4e4e0;
  --accent: #111111;
  --or: #b8860b;
}
html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--noir); font-family: 'Inter', sans-serif; font-size: 13px; line-height: 1.6; min-height: 100vh; }

/* ── HEADER ── */
header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 40px;
  display: flex; align-items: center; height: 54px;
}
.logo {
  font-family: 'Spectral', serif;
  font-size: 20px; font-weight: 600;
  letter-spacing: -0.02em; color: var(--noir);
}
.logo-dot { color: var(--or); }
.header-right { margin-left: auto; }
.btn-config {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; letter-spacing: 0.07em; text-transform: uppercase;
  padding: 5px 13px; border: 1px solid var(--border);
  border-radius: 3px; background: transparent;
  color: var(--doux); cursor: pointer; transition: all 0.15s;
}
.btn-config:hover { border-color: var(--gris); color: var(--fort); }
.btn-config.live { border-color: #3a7a3a; color: #2d6a2d; background: #f4fbf4; }

/* ── SEARCH AREA ── */
.search-area {
  max-width: 700px; margin: 52px auto 0; padding: 0 24px;
}
.brand-line {
  font-family: 'Spectral', serif;
  font-size: 13px; font-weight: 300;
  color: var(--doux); margin-bottom: 20px;
  letter-spacing: 0.01em;
}
.search-wrap {
  display: flex; border: 1px solid var(--border);
  border-radius: 3px; background: var(--surface);
  transition: border-color 0.15s; overflow: hidden;
}
.search-wrap:focus-within { border-color: var(--accent); }
#q {
  flex: 1; border: none; outline: none;
  padding: 13px 16px; font-family: 'Inter', sans-serif;
  font-size: 14px; color: var(--noir); background: transparent;
}
#q::placeholder { color: var(--doux); font-weight: 300; }
.btn-search {
  border: none; background: var(--accent); color: #fff;
  padding: 0 24px; font-family: 'Inter', sans-serif;
  font-size: 12px; font-weight: 500; cursor: pointer;
  transition: background 0.15s; letter-spacing: 0.02em;
}
.btn-search:hover { background: #2a2a2a; }
.search-hint {
  margin-top: 9px; font-size: 11px;
  color: var(--doux); font-family: 'JetBrains Mono', monospace;
}
.search-hint em { color: var(--gris); font-style: normal; }

/* Tags */
.tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 16px; }
.tag {
  font-size: 11px; padding: 3px 11px;
  border: 1px solid var(--border); border-radius: 20px;
  color: var(--gris); background: var(--surface);
  cursor: pointer; transition: all 0.12s;
}
.tag:hover { border-color: var(--accent); color: var(--accent); }

/* ── FILTRES ── */
.filters {
  max-width: 700px; margin: 14px auto 0; padding: 0 24px;
  display: flex; align-items: center; gap: 7px; flex-wrap: wrap;
}
.flabel {
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--doux); font-family: 'JetBrains Mono', monospace; margin-right: 2px;
}
.chip {
  font-size: 11px; padding: 3px 10px;
  border: 1px solid var(--border); border-radius: 2px;
  background: var(--surface); color: var(--gris);
  cursor: pointer; transition: all 0.1s;
}
.chip:hover { border-color: var(--fort); color: var(--fort); }
.chip.on { background: var(--accent); color: #fff; border-color: var(--accent); }
.fsep { width: 1px; height: 16px; background: var(--border); margin: 0 3px; }
.dpair { display: flex; align-items: center; gap: 5px; }
.dpair label { font-size: 10px; color: var(--doux); font-family: 'JetBrains Mono', monospace; }
.dpair input[type=number] {
  width: 60px; padding: 3px 7px;
  border: 1px solid var(--border); border-radius: 2px;
  font-size: 11px; font-family: 'JetBrains Mono', monospace;
  background: var(--surface); color: var(--noir); outline: none;
}
.dpair input:focus { border-color: var(--accent); }

/* ── RESULTS ── */
.results {
  max-width: 700px; margin: 32px auto 80px; padding: 0 24px;
}
.res-bar {
  display: flex; justify-content: space-between; align-items: center;
  padding-bottom: 11px; border-bottom: 1px solid var(--border);
  margin-bottom: 4px;
}
.res-info { font-size: 12px; color: var(--gris); }
.res-info strong { color: var(--noir); font-weight: 500; }
.sort-sel {
  font-size: 11px; border: 1px solid var(--border); border-radius: 2px;
  padding: 3px 8px; background: var(--surface); color: var(--gris);
  cursor: pointer; outline: none; font-family: 'Inter', sans-serif;
}
.demo-strip {
  font-size: 10px; font-family: 'JetBrains Mono', monospace;
  color: #7a6400; background: #fdf9e8; border: 1px solid #e8d870;
  border-radius: 2px; padding: 6px 12px; margin-bottom: 10px; display: none;
  letter-spacing: 0.03em;
}

/* ── CARD ── */
.card {
  border-bottom: 1px solid var(--border);
  padding: 18px 0 16px;
  animation: fu .18s ease both;
}
@keyframes fu { from { opacity:0; transform:translateY(3px); } to { opacity:1; transform:none; } }

.card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; cursor: pointer; }
.card-left { flex: 1; min-width: 0; }
.card-ref {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: var(--doux); margin-bottom: 5px; letter-spacing: 0.04em;
}
.card-title {
  font-family: 'Spectral', serif; font-size: 16px; font-weight: 400;
  color: var(--noir); line-height: 1.3;
}
.card-right {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: var(--doux); text-align: right; flex-shrink: 0; white-space: nowrap;
  line-height: 1.7;
}
.card-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
.badge {
  font-size: 9px; font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase; letter-spacing: 0.07em;
  padding: 2px 7px; border-radius: 2px;
  border: 1px solid var(--leger); color: var(--doux);
}
.badge.bull { border-color: #d4c060; color: #7a6000; background: #fdfbee; }
.badge.fs { border-color: var(--leger); }

.card-chapeau {
  font-size: 12.5px; color: var(--gris); line-height: 1.65; margin-top: 9px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  cursor: pointer;
}
.card.open .card-chapeau { display: block; }

/* Body étendu */
.card-body { display: none; margin-top: 14px; }
.card.open .card-body { display: block; }

.tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
.tab {
  font-size: 11px; padding: 7px 14px; color: var(--doux);
  cursor: pointer; border-bottom: 2px solid transparent;
  margin-bottom: -1px; transition: color 0.1s; font-weight: 400;
}
.tab:hover { color: var(--fort); }
.tab.on { color: var(--noir); border-bottom-color: var(--accent); font-weight: 500; }
.tab-pane { display: none; }
.tab-pane.on { display: block; }

/* Sommaire */
.sommaire {
  font-family: 'Spectral', serif; font-size: 13.5px; font-weight: 300;
  line-height: 1.8; color: var(--fort);
}
.attendu {
  margin-top: 12px; padding: 12px 16px;
  background: var(--bg); border-left: 2px solid var(--or);
  font-family: 'Spectral', serif; font-size: 13px; font-style: italic;
  font-weight: 300; line-height: 1.75; color: var(--gris);
}

/* Texte intégral */
.texte-wrap { position: relative; }
.texte-integral {
  font-family: 'Spectral', serif; font-size: 13px; font-weight: 300;
  line-height: 1.85; color: var(--fort); white-space: pre-wrap;
  max-height: 500px; overflow-y: auto;
  padding: 16px 18px;
  background: var(--surface); border: 1px solid var(--border); border-radius: 2px;
}
.texte-integral::-webkit-scrollbar { width: 3px; }
.texte-integral::-webkit-scrollbar-thumb { background: var(--leger); }
.texte-loading {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  color: var(--doux); text-align: center; padding: 32px;
  letter-spacing: 0.06em; text-transform: uppercase;
}

/* Zones structurées */
.zones { display: grid; gap: 14px; }
.zone { }
.zone-label {
  font-size: 9px; font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--doux); margin-bottom: 6px;
}
.zone-content {
  font-family: 'Spectral', serif; font-size: 13px; font-weight: 300;
  line-height: 1.8; color: var(--fort);
  padding: 12px 14px; border-left: 2px solid var(--leger);
  background: var(--bg);
}
.zone-content.motivations { border-left-color: var(--accent); }
.zone-content.moyens { border-left-color: var(--or); }
.zone-content.dispositif { border-left-color: #3a7a3a; }

/* Pied de carte */
.card-foot {
  display: flex; gap: 8px; align-items: center;
  margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border);
}
.btn-sm {
  font-size: 11px; padding: 5px 12px; border-radius: 2px;
  cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.12s;
  text-decoration: none; display: inline-block;
}
.btn-outline { border: 1px solid var(--border); background: transparent; color: var(--gris); }
.btn-outline:hover { border-color: var(--fort); color: var(--fort); }
.btn-ghost { border: 1px solid transparent; background: transparent; color: var(--doux); }
.btn-ghost:hover { color: var(--gris); }

/* Loader */
.loader { display: none; padding: 60px; text-align: center; }
.loader.on { display: block; }
.dots { display: inline-flex; gap: 5px; }
.dots i {
  display: block; width: 4px; height: 4px;
  background: var(--leger); border-radius: 50%;
  animation: blink .9s ease infinite;
}
.dots i:nth-child(2) { animation-delay:.15s; }
.dots i:nth-child(3) { animation-delay:.3s; }
@keyframes blink { 0%,60%,100%{transform:none;opacity:.4} 30%{transform:translateY(-5px);opacity:1} }

.empty { display:none; padding:60px; text-align:center; font-size:13px; color:var(--doux); }
.empty.on { display:block; }

/* ── MODAL ── */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.35);
  z-index: 900; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(2px);
}
.overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 4px; padding: 36px;
  max-width: 440px; width: 90%;
  box-shadow: 0 16px 56px rgba(0,0,0,0.12);
}
.modal h2 {
  font-family: 'Spectral', serif; font-size: 20px;
  font-weight: 400; margin-bottom: 6px; color: var(--noir);
}
.modal-sub { font-size: 12px; color: var(--gris); line-height: 1.7; margin-bottom: 22px; }
.modal-sub a { color: var(--accent); }
.field { margin-bottom: 14px; }
.field label {
  display: block; font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--doux);
  font-family: 'JetBrains Mono', monospace; margin-bottom: 5px;
}
.field input {
  width: 100%; border: 1px solid var(--border); border-radius: 2px;
  padding: 9px 12px; font-family: 'JetBrains Mono', monospace;
  font-size: 12px; outline: none; color: var(--noir); background: var(--surface);
}
.field input:focus { border-color: var(--accent); }
.env-row { display: flex; gap: 8px; margin-bottom: 18px; }
.env-btn {
  flex: 1; padding: 8px 10px; border: 1px solid var(--border);
  border-radius: 2px; font-size: 11px; font-family: 'JetBrains Mono', monospace;
  text-align: center; cursor: pointer; color: var(--gris);
  transition: all 0.1s; background: var(--surface);
}
.env-btn.on { border-color: var(--accent); color: var(--accent); background: #f5f5f5; font-weight: 500; }
.modal-btns { display: flex; gap: 8px; margin-top: 22px; }
.btn-prim {
  background: var(--accent); color: #fff; border: none;
  border-radius: 2px; padding: 10px 22px;
  font-size: 12px; font-weight: 500; cursor: pointer;
  font-family: 'Inter', sans-serif; transition: background 0.15s;
}
.btn-prim:hover { background: #2a2a2a; }
.btn-sec {
  background: transparent; color: var(--gris);
  border: 1px solid var(--border); border-radius: 2px;
  padding: 10px 16px; font-size: 12px; cursor: pointer;
  font-family: 'Inter', sans-serif;
}

@media (max-width: 620px) {
  header { padding: 0 16px; }
  .search-area, .filters, .results { padding: 0 16px; }
  .search-area { margin-top: 28px; }
}
</style>
</head>
<body>

<!-- MODAL CONFIG -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h2>Connexion API</h2>
    <p class="modal-sub">
      Sur <a href="https://piste.gouv.fr" target="_blank">piste.gouv.fr</a>, cr&eacute;ez une application,
      cochez <strong>Judilibre</strong> (sandbox et/ou production), acceptez les CGU.
      R&eacute;cup&eacute;rez votre <em>Client ID</em> et <em>Client Secret</em>.
    </p>
    <div class="field">
      <label>Environnement</label>
      <div class="env-row">
        <div class="env-btn on" id="eSbx" onclick="setEnv('sandbox')">Sandbox</div>
        <div class="env-btn" id="eProd" onclick="setEnv('production')">Production</div>
      </div>
    </div>
    <div class="field"><label>Client ID</label><input type="text" id="cfgId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></div>
    <div class="field"><label>Client Secret</label><input type="password" id="cfgSec" placeholder="&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;"></div>
    <div class="modal-btns">
      <button class="btn-prim" onclick="saveConfig()">Enregistrer</button>
      <button class="btn-sec" onclick="closeModal()">Annuler</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">Cassio<span class="logo-dot">.</span></div>
  <div class="header-right">
    <button class="btn-config" id="btnCfg" onclick="openModal()">&#9881; API</button>
  </div>
</header>

<!-- SEARCH -->
<div class="search-area">
  <p class="brand-line">Jurisprudence Cour de cassation &amp; cours d&apos;appel</p>
  <div class="search-wrap">
    <input type="text" id="q" placeholder="caducit&eacute;, bail&hellip; ou force majeure, 1218&hellip;" autocomplete="off">
    <button class="btn-search" onclick="doSearch()">Chercher</button>
  </div>
  <p class="search-hint">S&eacute;parez par une virgule pour combiner &mdash; ex. <em>caducit&eacute;, contrat de bail, 1117</em></p>
  <div class="tags">
    <span class="tag" onclick="fill('caducit&eacute;')">caducit&eacute;</span>
    <span class="tag" onclick="fill('force majeure, 1218')">force majeure</span>
    <span class="tag" onclick="fill('abus de droit')">abus de droit</span>
    <span class="tag" onclick="fill('bonne foi, 1104')">bonne foi</span>
    <span class="tag" onclick="fill('prescription, 2224')">prescription</span>
    <span class="tag" onclick="fill('nullit&eacute;, dol')">nullit&eacute; &amp; dol</span>
    <span class="tag" onclick="fill('enrichissement injustifi&eacute;, 1303')">enrichissement injustifi&eacute;</span>
    <span class="tag" onclick="fill('vices cach&eacute;s, 1641')">vices cach&eacute;s</span>
    <span class="tag" onclick="fill('licenciement, L1235-3')">licenciement</span>
    <span class="tag" onclick="fill('responsabilit&eacute; d&eacute;lictuelle, 1240')">resp. d&eacute;lictuelle</span>
  </div>
</div>

<!-- FILTRES -->
<div class="filters">
  <span class="flabel">Chambre</span>
  <button class="chip on" data-ch="">Toutes</button>
  <button class="chip" data-ch="civ1">1re Civ.</button>
  <button class="chip" data-ch="civ2">2e Civ.</button>
  <button class="chip" data-ch="civ3">3e Civ.</button>
  <button class="chip" data-ch="com">Com.</button>
  <button class="chip" data-ch="soc">Soc.</button>
  <button class="chip" data-ch="crim">Crim.</button>
  <button class="chip" data-ch="ap">Ass. pl&eacute;n.</button>
  <div class="fsep"></div>
  <div class="dpair">
    <label>De</label>
    <input type="number" id="dFrom" placeholder="2000" min="1960" max="2025">
    <label>&agrave;</label>
    <input type="number" id="dTo" placeholder="2025" min="1960" max="2025">
  </div>
</div>

<!-- RESULTS -->
<div class="results">
  <div class="demo-strip" id="demoStrip">Mode d&eacute;mo &mdash; donn&eacute;es repr&eacute;sentatives. Connectez l&apos;API pour les d&eacute;cisions r&eacute;elles.</div>
  <div id="resBar" style="display:none" class="res-bar">
    <span class="res-info" id="resInfo"></span>
    <select class="sort-sel" id="sortSel">
      <option value="score">Pertinence</option>
      <option value="date_desc">Date &darr;</option>
      <option value="date_asc">Date &uarr;</option>
    </select>
  </div>
  <div class="loader" id="loader"><div class="dots"><i></i><i></i><i></i></div></div>
  <div id="list"></div>
  <div class="empty" id="empty">Aucune d&eacute;cision trouv&eacute;e.</div>
</div>

<script>
// ─── CONFIG ───────────────────────────────────────────────
var env    = localStorage.getItem('cassio_env') || 'sandbox';
var cfgId  = localStorage.getItem('cassio_id')  || '';
var cfgSec = localStorage.getItem('cassio_sec') || '';
var token  = null, tokenExp = 0;
var activeCh = '';
var currentResults = [];

function isLive() { return cfgId && cfgSec; }

function updateBtn() {
  var b = document.getElementById('btnCfg');
  if (isLive()) {
    b.textContent = (env === 'production' ? 'PROD' : 'SANDBOX') + ' \u2713';
    b.className = 'btn-config live';
  } else {
    b.textContent = '\u2699 API';
    b.className = 'btn-config';
  }
}
updateBtn();

function setEnv(e) {
  env = e;
  document.getElementById('eSbx').className  = 'env-btn' + (e==='sandbox'   ? ' on' : '');
  document.getElementById('eProd').className = 'env-btn' + (e==='production' ? ' on' : '');
}
function openModal() {
  document.getElementById('cfgId').value  = cfgId;
  document.getElementById('cfgSec').value = cfgSec;
  setEnv(env);
  document.getElementById('overlay').classList.add('open');
}
function closeModal() { document.getElementById('overlay').classList.remove('open'); }
function saveConfig() {
  cfgId  = document.getElementById('cfgId').value.trim();
  cfgSec = document.getElementById('cfgSec').value.trim();
  token  = null; tokenExp = 0;
  localStorage.setItem('cassio_id',  cfgId);
  localStorage.setItem('cassio_sec', cfgSec);
  localStorage.setItem('cassio_env', env);
  updateBtn(); closeModal();
}
document.getElementById('overlay').addEventListener('click', function(e) {
  if (e.target === document.getElementById('overlay')) closeModal();
});

// Chips chambre
document.querySelectorAll('.chip').forEach(function(b) {
  b.addEventListener('click', function() {
    document.querySelectorAll('.chip').forEach(function(x){ x.classList.remove('on'); });
    b.classList.add('on'); activeCh = b.dataset.ch;
    if (document.getElementById('list').children.length) doSearch();
  });
});
document.getElementById('q').addEventListener('keydown', function(e){ if(e.key==='Enter') doSearch(); });
document.getElementById('sortSel').addEventListener('change', function(e){ sortResults(e.target.value); });
function fill(t) { document.getElementById('q').value = t; doSearch(); }

// ─── DEMO DATA ────────────────────────────────────────────
var DEMO = [
  { id:'D1', numero:'17-27.567', chambre:'1re chambre civile', date:'17 janvier 2019', dateY:2019, formation:'FS-P+B', bull:true,
    titre:'Caducit\u00e9 de l\'offre \u2014 D\u00e9c\u00e8s de l\'offrant avant acceptation',
    chapeau:'La caducit\u00e9 de l\'offre r\u00e9sulte automatiquement du d\u00e9c\u00e8s de l\'offrant survenu avant son acceptation, sans que le destinataire puisse se pr\u00e9valoir d\'un droit \u00e0 la conclusion du contrat.',
    sommaire:'Il r\u00e9sulte de l\'article 1117 du Code civil que l\'offre est caduque \u00e0 l\'expiration du d\u00e9lai fix\u00e9 par son auteur ou, \u00e0 d\u00e9faut, \u00e0 l\'issue d\'un d\u00e9lai raisonnable. Elle l\'est \u00e9galement en cas de d\u00e9c\u00e8s ou d\'incapacit\u00e9 de l\'offrant. La caducit\u00e9 op\u00e8re de plein droit, ind\u00e9pendamment de la connaissance qu\'en a le destinataire.',
    attendu:'Attendu que l\'offre est caduque en cas de d\u00e9c\u00e8s de son auteur survenu avant son acceptation\u00a0; que la cour d\'appel, qui a fait exacte application de ce principe, a l\u00e9galement justifi\u00e9 sa d\u00e9cision\u00a0; PAR CES MOTIFS\u00a0: REJETTE le pourvoi.',
    mots:['caducit\u00e9','offre','d\u00e9c\u00e8s','contrat','1117','caduc'], url:'https://www.legifrance.gouv.fr/juri/id/JURITEXT000038048835' },
  { id:'D2', numero:'18-21.815', chambre:'3e chambre civile', date:'27 juin 2019', dateY:2019, formation:'FS-P+B+I', bull:true,
    titre:'Caducit\u00e9 du compromis \u2014 Condition suspensive de pr\u00eat d\u00e9faillie',
    chapeau:'Le compromis de vente est frapp\u00e9 de caducit\u00e9 lorsque la condition suspensive d\'obtention d\'un pr\u00eat n\'est pas r\u00e9alis\u00e9e dans le d\u00e9lai convenu\u00a0; la caducit\u00e9 est automatique, sans mise en demeure pr\u00e9alable.',
    sommaire:'La condition suspensive d\'obtention d\'un pr\u00eat immobilier emporte caducit\u00e9 du compromis lorsqu\'elle ne se r\u00e9alise pas dans le d\u00e9lai pr\u00e9vu. Conform\u00e9ment \u00e0 l\'article 1304-3 du Code civil, la partie qui a d\u00e9lib\u00e9r\u00e9ment emp\u00each\u00e9 la r\u00e9alisation de la condition ne peut se pr\u00e9valoir de sa d\u00e9faillance.',
    attendu:'Qu\'en statuant sans rechercher si l\'acqu\u00e9reur n\'avait pas d\u00e9lib\u00e9r\u00e9ment emp\u00each\u00e9 la r\u00e9alisation de la condition suspensive, la cour d\'appel a priv\u00e9 sa d\u00e9cision de base l\u00e9gale\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE l\'arr\u00eat.',
    mots:['caducit\u00e9','compromis','condition suspensive','pr\u00eat','bail','1304-3'], url:'https://www.legifrance.gouv.fr' },
  { id:'D3', numero:'16-18.792', chambre:'3e chambre civile', date:'14 septembre 2017', dateY:2017, formation:'FS-P+B', bull:true,
    titre:'Promesse unilat\u00e9rale de vente \u2014 R\u00e9tractation du promettant (revirement)',
    chapeau:'La r\u00e9tractation du promettant avant la lev\u00e9e de l\'option n\'emp\u00eache pas la formation de la vente d\u00e8s lors que le b\u00e9n\u00e9ficiaire l\u00e8ve l\'option dans le d\u00e9lai convenu.',
    sommaire:'Par ce revirement, la Cour juge que la r\u00e9tractation du promettant n\'emp\u00eache pas la formation du contrat, consacrant la solution de l\'article 1124 du Code civil issu de la r\u00e9forme de 2016. Ce revirement met fin \u00e0 la distinction entre obligation de faire et obligation de donner.',
    attendu:'La r\u00e9tractation du promettant, intervenue avant la lev\u00e9e de l\'option, n\'emp\u00eache pas la formation du contrat de vente\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE.',
    mots:['caducit\u00e9','promesse unilat\u00e9rale','option','r\u00e9tractation','1124'], url:'https://www.legifrance.gouv.fr' },
  { id:'D4', numero:'19-13.459', chambre:'Chambre commerciale', date:'9 octobre 2019', dateY:2019, formation:'FS-P+B', bull:false,
    titre:'Force majeure \u2014 Triple condition cumulative (art. 1218)',
    chapeau:'Le d\u00e9biteur qui invoque la force majeure doit rapporter la preuve que l\'\u00e9v\u00e9nement est ext\u00e9rieur, impr\u00e9visible au moment de la formation du contrat, et irr\u00e9sistible dans ses effets.',
    sommaire:'La force majeure au sens de l\'article 1218 suppose trois conditions cumulatives\u00a0: ext\u00e9riorit\u00e9, impr\u00e9visibilit\u00e9 lors de la conclusion, irr\u00e9sistibilit\u00e9 dans les effets. La simple difficult\u00e9 \u00e9conomique, m\u00eame grave, ne satisfait pas ces crit\u00e8res.',
    attendu:'Attendu que seul un \u00e9v\u00e9nement ext\u00e9rieur, impr\u00e9visible lors de la conclusion du contrat et irr\u00e9sistible dans son ex\u00e9cution, peut constituer un cas de force majeure\u00a0; PAR CES MOTIFS\u00a0: REJETTE le pourvoi.',
    mots:['force majeure','impr\u00e9visibilit\u00e9','irr\u00e9sistibilit\u00e9','1218','exon\u00e9ration','cas fortuit'], url:'https://www.legifrance.gouv.fr' },
  { id:'D5', numero:'19-24.396', chambre:'1re chambre civile', date:'17 mars 2021', dateY:2021, formation:'FS-P', bull:false,
    titre:'Abus de droit \u2014 R\u00e9siliation unilat\u00e9rale dans un but vexatoire',
    chapeau:'L\'exercice d\'un droit contractuel de r\u00e9siliation dans des conditions vexatoires ou avec intention de nuire constitue un abus de droit ouvrant droit \u00e0 dommages-int\u00e9r\u00eats.',
    sommaire:'L\'abus de droit fond\u00e9 sur l\'article 1240 suppose une faute dans les modalit\u00e9s d\'exercice du droit, et non dans son principe. L\'exercice d\'un droit ne constitue un abus que lorsqu\'il est r\u00e9alis\u00e9 dans des circonstances \u00e9trang\u00e8res \u00e0 sa finalit\u00e9 normale.',
    attendu:'L\'exercice d\'un droit ne saurait constituer un abus que lorsqu\'il est r\u00e9alis\u00e9 dans des circonstances ou un but \u00e9tranger \u00e0 sa finalit\u00e9 normale\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE.',
    mots:['abus de droit','r\u00e9siliation','1240','vexatoire','intention de nuire'], url:'https://www.legifrance.gouv.fr' },
  { id:'D6', numero:'20-14.808', chambre:'Chambre sociale', date:'2 juin 2021', dateY:2021, formation:'FS-P+R', bull:true,
    titre:'Licenciement \u2014 Bar\u00e8me Macron compatible avec la Convention OIT n\u00b0\u00a0158',
    chapeau:'Le bar\u00e8me d\'indemnisation du licenciement sans cause r\u00e9elle et s\u00e9rieuse (art. L.\u00a01235-3 C. trav.) est compatible avec l\'article\u00a010 de la Convention OIT n\u00b0\u00a0158.',
    sommaire:'La Cour juge que les juges du fond ne peuvent \u00e9carter ce bar\u00e8me pour accorder une indemnisation sup\u00e9rieure, sauf \u00e0 caract\u00e9riser un pr\u00e9judice distinct relevant d\'un autre fondement juridique.',
    attendu:'Le bar\u00e8me pr\u00e9vu \u00e0 l\'article L.\u00a01235-3 du Code du travail est compatible avec les stipulations de l\'article\u00a010 de la Convention n\u00b0\u00a0158 de l\'OIT\u00a0; PAR CES MOTIFS\u00a0: REJETTE le pourvoi.',
    mots:['licenciement','cause r\u00e9elle','s\u00e9rieuse','bar\u00e8me','L1235-3','OIT'], url:'https://www.legifrance.gouv.fr' },
  { id:'D7', numero:'18-14.844', chambre:'2e chambre civile', date:'15 novembre 2018', dateY:2018, formation:'FS-P+B', bull:false,
    titre:'Pr\u00e9judice moral \u2014 Pretium doloris, \u00e9valuation distincte',
    chapeau:'Le pretium doloris doit faire l\'objet d\'une \u00e9valuation distincte et ne peut \u00eatre absorb\u00e9 par une globalisation indiff\u00e9renci\u00e9e des postes de pr\u00e9judice.',
    sommaire:'Le principe de r\u00e9paration int\u00e9grale impose que chaque poste soit indemnis\u00e9 distinctement. Le pretium doloris, les pr\u00e9judices d\'agr\u00e9ment et esth\u00e9tique constituent des postes autonomes. La nomenclature Dintilhac constitue un cadre de r\u00e9f\u00e9rence pour assurer une r\u00e9paration exhaustive.',
    attendu:'En ne distinguant pas les diff\u00e9rents chefs de pr\u00e9judice, la cour d\'appel a viol\u00e9 le principe de r\u00e9paration int\u00e9grale\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE.',
    mots:['pr\u00e9judice moral','pretium doloris','r\u00e9paration int\u00e9grale','Dintilhac'], url:'https://www.legifrance.gouv.fr' },
  { id:'D8', numero:'15-27.913', chambre:'1re chambre civile', date:'25 janvier 2017', dateY:2017, formation:'FS-P+B+I', bull:true,
    titre:'Nullit\u00e9 \u2014 Dol par r\u00e9ticence et obligation pr\u00e9contractuelle d\'information',
    chapeau:'Le silence gard\u00e9 sur une information d\u00e9terminante du consentement constitue un dol par r\u00e9ticence susceptible d\'entra\u00eener la nullit\u00e9 du contrat.',
    sommaire:'L\'article 1137 du Code civil incrimine le dol par r\u00e9ticence\u00a0: dissimuler intentionnellement une information d\u00e9terminante du consentement. La nullit\u00e9 pour dol suppose un \u00e9l\u00e9ment intentionnel, ce qui distingue ce vice de la simple erreur.',
    attendu:'Le dol peut \u00eatre constitu\u00e9 par le silence d\'une partie dissimulant un fait qui, s\'il avait \u00e9t\u00e9 connu, aurait emp\u00each\u00e9 son cocontractant de contracter\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE.',
    mots:['nullit\u00e9','dol','r\u00e9ticence','obligation d\'information','1137','annulation'], url:'https://www.legifrance.gouv.fr' },
  { id:'D9', numero:'21-10.685', chambre:'Chambre criminelle', date:'3 novembre 2021', dateY:2021, formation:'FS-P+B', bull:false,
    titre:'Garde \u00e0 vue \u2014 Assistance de l\'avocat d\u00e8s la premi\u00e8re heure',
    chapeau:'Toute audition en garde \u00e0 vue sans assistance de l\'avocat, hors renonciation libre et \u00e9clair\u00e9e, entache la proc\u00e9dure d\'une nullit\u00e9 substantielle portant atteinte aux droits de la d\u00e9fense.',
    sommaire:'La CEDH et la Cour de cassation consacrent le droit \u00e0 l\'assistance effective d\'un avocat d\u00e8s le d\u00e9but de la garde \u00e0 vue. Toute audition r\u00e9alis\u00e9e sans avocat, sans renonciation \u00e9clair\u00e9e, entache la proc\u00e9dure d\'une nullit\u00e9 substantielle au regard de l\'article\u00a06 CEDH.',
    attendu:'La personne gard\u00e9e \u00e0 vue a le droit d\'\u00eatre assist\u00e9e par un avocat d\u00e8s le d\u00e9but de la mesure et lors de chaque audition\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE.',
    mots:['garde \u00e0 vue','avocat','CEDH','nullit\u00e9','droits de la d\u00e9fense'], url:'https://www.legifrance.gouv.fr' },
  { id:'D10', numero:'20-22.218', chambre:'1re chambre civile', date:'14 avril 2021', dateY:2021, formation:'FS-P', bull:false,
    titre:'Impr\u00e9vision \u2014 Obligation de ren\u00e9gociation de bonne foi (art.\u00a01195)',
    chapeau:'L\'article 1195 du Code civil impose aux parties d\'un contrat affect\u00e9 par un changement impr\u00e9visible de ren\u00e9gocier de bonne foi, pr\u00e9alablement \u00e0 toute demande judiciaire.',
    sommaire:'L\'impr\u00e9vision consacr\u00e9e \u00e0 l\'article\u00a01195 impose une obligation de ren\u00e9gociation pr\u00e9alable. La partie qui n\'a pas tent\u00e9 de ren\u00e9gocier de bonne foi ne peut saisir directement le juge. La bonne foi s\'impose tant dans la formation que dans l\'ex\u00e9cution du contrat.',
    attendu:'La partie qui n\'a pas ren\u00e9goci\u00e9 de bonne foi ne peut solliciter du juge la r\u00e9vision ou la r\u00e9solution sur le fondement de l\'article\u00a01195 du Code civil\u00a0; PAR CES MOTIFS\u00a0: REJETTE.',
    mots:['bonne foi','impr\u00e9vision','ren\u00e9gociation','1195','1104','loyaut\u00e9'], url:'https://www.legifrance.gouv.fr' },
  { id:'D11', numero:'19-20.397', chambre:'Chambre commerciale', date:'8 juillet 2020', dateY:2020, formation:'FS-P+B', bull:false,
    titre:'Enrichissement injustifi\u00e9 \u2014 Caract\u00e8re subsidiaire de l\'action de in rem verso',
    chapeau:'L\'action fond\u00e9e sur l\'enrichissement injustifi\u00e9 est subsidiaire\u00a0; elle est irrecevable d\u00e8s lors qu\'une autre action est ouverte au demandeur, m\u00eame prescrite.',
    sommaire:'L\'article 1303 du Code civil consacre l\'enrichissement injustifi\u00e9 comme source autonome d\'obligation. La Cour maintient le caract\u00e8re subsidiaire de l\'action de in rem verso\u00a0: irrecevable m\u00eame si l\'autre action est prescrite ou vou\u00e9e \u00e0 l\'\u00e9chec.',
    attendu:'L\'action fond\u00e9e sur l\'enrichissement injustifi\u00e9 est subsidiaire et ne peut \u00eatre exerc\u00e9e lorsque le demandeur dispose d\'une autre action\u00a0; PAR CES MOTIFS\u00a0: REJETTE.',
    mots:['enrichissement injustifi\u00e9','in rem verso','1303','subsidiaire','quasi-contrat'], url:'https://www.legifrance.gouv.fr' },
  { id:'D12', numero:'18-23.948', chambre:'Assembl\u00e9e pl\u00e9ni\u00e8re', date:'6 novembre 2020', dateY:2020, formation:'Ass. pl\u00e9n.', bull:true,
    titre:'Prescription quinquennale \u2014 Point de d\u00e9part et connaissance du dommage',
    chapeau:'En mati\u00e8re de responsabilit\u00e9, le d\u00e9lai de prescription court \u00e0 compter du jour o\u00f9 le titulaire a connu ou aurait d\u00fb conna\u00eetre les faits permettant l\'exercice de l\'action.',
    sommaire:'L\'article 2224 fixe le point de d\u00e9part au jour o\u00f9 le titulaire a connu les faits lui permettant d\'agir. En responsabilit\u00e9 m\u00e9dicale, ce point ne co\u00efncide pas n\u00e9cessairement avec la date du dommage mais avec la connaissance du lien de causalit\u00e9.',
    attendu:'Le d\u00e9lai de prescription court \u00e0 compter du jour o\u00f9 la victime a connu ou aurait d\u00fb conna\u00eetre les faits permettant d\'exercer son action\u00a0; PAR CES MOTIFS\u00a0: REJETTE.',
    mots:['prescription','2224','point de d\u00e9part','connaissance','dommage','responsabilit\u00e9'], url:'https://www.legifrance.gouv.fr' },
  { id:'D13', numero:'20-16.640', chambre:'Chambre sociale', date:'25 novembre 2020', dateY:2020, formation:'FS-P+R+I', bull:true,
    titre:'Harc\u00e8lement moral \u2014 Obligation de s\u00e9curit\u00e9 et exon\u00e9ration de l\'employeur',
    chapeau:'L\'employeur ne peut s\'exon\u00e9rer de sa responsabilit\u00e9 pour harc\u00e8lement moral qu\'en d\u00e9montrant avoir pris toutes les mesures pr\u00e9ventives pr\u00e9vues aux articles L.\u00a04121-1 et L.\u00a04121-2 C.\u00a0trav.',
    sommaire:'L\'obligation de s\u00e9curit\u00e9 impose \u00e0 l\'employeur de prot\u00e9ger la sant\u00e9 physique et mentale de ses salari\u00e9s. En mati\u00e8re de harc\u00e8lement moral, l\'exon\u00e9ration suppose la preuve de toutes les mesures pr\u00e9ventives l\u00e9galement pr\u00e9vues.',
    attendu:'Ne m\u00e9conna\u00eet pas l\'obligation de s\u00e9curit\u00e9 l\'employeur qui justifie avoir pris toutes les mesures pr\u00e9vues par les articles L.\u00a04121-1 et L.\u00a04121-2 du Code du travail\u00a0; PAR CES MOTIFS\u00a0: REJETTE.',
    mots:['harc\u00e8lement moral','employeur','L4121-1','obligation de s\u00e9curit\u00e9'], url:'https://www.legifrance.gouv.fr' },
  { id:'D14', numero:'17-31.079', chambre:'2e chambre civile', date:'8 mars 2018', dateY:2018, formation:'FS-P+B', bull:false,
    titre:'Responsabilit\u00e9 d\u00e9lictuelle \u2014 Faute de la victime et partage',
    chapeau:'La faute de la victime, m\u00eame partielle, r\u00e9duit son droit \u00e0 r\u00e9paration en proportion de sa contribution au dommage, y compris pour le pr\u00e9judice moral.',
    sommaire:'Les juges disposent d\'un pouvoir souverain pour appr\u00e9cier la part de responsabilit\u00e9 de chacun. La r\u00e9duction proportionnelle s\'applique \u00e0 l\'ensemble des postes de pr\u00e9judice, sans exclusion possible.',
    attendu:'La faute de la victime r\u00e9duit son droit \u00e0 r\u00e9paration dans la proportion o\u00f9 cette faute a contribu\u00e9 au dommage\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE partiellement.',
    mots:['responsabilit\u00e9 d\u00e9lictuelle','faute victime','partage','1240','1241'], url:'https://www.legifrance.gouv.fr' },
  { id:'D15', numero:'19-11.714', chambre:'3e chambre civile', date:'23 janvier 2020', dateY:2020, formation:'FS-P+B+R', bull:true,
    titre:'Vices cach\u00e9s \u2014 Pr\u00e9somption irr\u00e9fragable de connaissance du vendeur professionnel',
    chapeau:'Le vendeur professionnel, pr\u00e9sum\u00e9 conna\u00eetre les vices, ne peut opposer une clause limitative ou exclusive de garantie \u00e0 l\'acheteur non professionnel.',
    sommaire:'La garantie des vices cach\u00e9s (art. 1641 s.) impose de d\u00e9livrer une chose exempte de d\u00e9fauts cach\u00e9s. Le vendeur professionnel est irr\u00e9fragablement pr\u00e9sum\u00e9 avoir connu le vice, ce qui le prive de toute clause exon\u00e9ratoire \u00e0 l\'\u00e9gard des non-professionnels.',
    attendu:'Le vendeur professionnel, pr\u00e9sum\u00e9 conna\u00eetre les vices, ne peut s\'exon\u00e9rer par une clause limitative\u00a0; PAR CES MOTIFS\u00a0: CASSE ET ANNULE.',
    mots:['vices cach\u00e9s','1641','vendeur professionnel','clause exon\u00e9ratoire','garantie'], url:'https://www.legifrance.gouv.fr' }
];

// ─── SCORING ──────────────────────────────────────────────
var SYN = {
  'caducite':['caduc','caduque','1117','1304','extinctif'],
  'force majeure':['cas fortuit','imprevisible','irresistible','1218','exoneration'],
  'prescription':['delai','2224','forclusion','point de depart'],
  'responsabilite':['faute','dommage','prejudice','causalite','reparation','1240','1241'],
  'nullite':['vice','dol','erreur','violence','annulation','1130'],
  'bonne foi':['loyaute','imprevision','renegociation','1104','1195'],
  'enrichissement':['in rem verso','1303','appauvrissement','subsidiaire'],
  'abus':['detournement','vexatoire','intention de nuire'],
  'harcelement':['moral','securite','L4121'],
  'licenciement':['cause reelle','serieuse','bareme','L1235'],
};

function n(s){ return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

function parseTerms(raw) {
  // sépare par virgule, chaque terme est une "phrase" à matcher
  return raw.split(',').map(function(t){ return t.trim(); }).filter(function(t){ return t.length > 0; });
}

function scoreArret(a, terms) {
  var hay = n([a.titre,a.chapeau,a.sommaire,a.attendu].concat(a.mots).join(' '));
  var score = 0;
  terms.forEach(function(term) {
    var q = n(term);
    var words = q.split(/\s+/).filter(function(w){ return w.length > 1; });
    // phrase exacte = gros bonus
    if (hay.includes(q)) score += 40;
    // mots individuels
    words.forEach(function(w){ if(hay.includes(w)) score += 10; });
    // mots-clés directs
    a.mots.forEach(function(m){ if(words.some(function(w){ return n(m).includes(w); })) score += 20; });
    // synonymes
    Object.entries(SYN).forEach(function(e){
      if(words.some(function(w){ return n(e[0]).includes(w)||w.includes(n(e[0]).split(' ')[0]); })){
        e[1].forEach(function(s){ if(hay.includes(n(s))) score += 6; });
      }
    });
  });
  // bonus si TOUS les termes matchent (recherche combinée)
  if (terms.length > 1) {
    var allMatch = terms.every(function(term){
      var q = n(term);
      return hay.includes(q) || q.split(/\s+/).some(function(w){ return w.length>1 && hay.includes(w); });
    });
    if (allMatch) score += 30;
  }
  return score;
}

// ─── API ──────────────────────────────────────────────────
var URLS = {
  sandbox:    { oauth: 'https://sandbox-oauth.piste.gouv.fr/api/oauth/token', api: 'https://sandbox-api.piste.gouv.fr/cassation/judilibre/v1.0' },
  production: { oauth: 'https://oauth.piste.gouv.fr/api/oauth/token',         api: 'https://api.piste.gouv.fr/cassation/judilibre/v1.0' }
};
var CHMAP = {
  civ1:'Premi\u00e8re chambre civile', civ2:'Deuxi\u00e8me chambre civile',
  civ3:'Troisi\u00e8me chambre civile', com:'Chambre commerciale',
  soc:'Chambre sociale', crim:'Chambre criminelle', ap:'Assembl\u00e9e pl\u00e9ni\u00e8re'
};

async function getToken() {
  if (token && Date.now() < tokenExp) return token;
  var r = await fetch(URLS[env].oauth, {
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: new URLSearchParams({ grant_type:'client_credentials', client_id:cfgId, client_secret:cfgSec, scope:'openid' })
  });
  if (!r.ok) throw new Error('Authentification \u00e9chou\u00e9e (v\u00e9rifiez vos credentials)');
  var d = await r.json();
  token = d.access_token;
  tokenExp = Date.now() + (d.expires_in - 30) * 1000;
  return token;
}

async function searchAPI(rawQuery) {
  var t = await getToken();
  // pour l'API on envoie tous les termes combinés dans un seul query
  var apiQuery = parseTerms(rawQuery).join(' ');
  var p = new URLSearchParams({ query:apiQuery, field:'all', page_size:20, page_number:0, sort:'score' });
  if (activeCh && CHMAP[activeCh]) p.append('chamber', CHMAP[activeCh]);
  var df = document.getElementById('dFrom').value, dt = document.getElementById('dTo').value;
  if (df) p.append('date_start', df+'-01-01');
  if (dt) p.append('date_end',   dt+'-12-31');
  var r = await fetch(URLS[env].api+'/search?'+p, { headers:{'Authorization':'Bearer '+t,'Accept':'application/json'} });
  if (!r.ok) throw new Error('Erreur API '+r.status);
  var d = await r.json();
  return (d.results||[]).map(function(x){
    return {
      id:x.id, numero:x.number||'\u2014', chambre:x.chamber||'\u2014',
      date:x.decision_date?new Date(x.decision_date).toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'}):'\u2014',
      dateY:x.decision_date?new Date(x.decision_date).getFullYear():null,
      formation:x.formation||'', bull:!!(x.publication&&x.publication.includes('B')),
      titre:(x.summary||'').slice(0,160)||'(sans titre)',
      chapeau:(x.summary||'').slice(0,320),
      sommaire:x.summary||'', attendu:'',
      mots:x.themes||[], url:x.permalink||'https://www.legifrance.gouv.fr/juri/id/'+x.id,
      _apiId: x.id
    };
  });
}

async function fetchTexte(cardId, apiId) {
  var pane = document.getElementById('pane-texte-'+cardId);
  if (!apiId || !isLive()) {
    pane.innerHTML = '<p style="font-family:\'Spectral\',serif;font-size:13px;font-weight:300;color:#8a8a8a;padding:16px;">Texte int\u00e9gral disponible une fois connect\u00e9 \u00e0 l\'API.</p>';
    return;
  }
  pane.innerHTML = '<div class="texte-loading">Chargement\u2026</div>';
  try {
    var t = await getToken();
    var r = await fetch(URLS[env].api+'/decision/'+apiId, { headers:{'Authorization':'Bearer '+t,'Accept':'application/json'} });
    if (!r.ok) throw new Error(r.status);
    var d = await r.json();
    var txt = d.text || d.summary || '';
    if (!txt) { pane.innerHTML = '<p style="font-family:\'Spectral\',serif;font-size:13px;color:#8a8a8a;padding:16px;">Texte non disponible pour cette d\u00e9cision.</p>'; return; }
    pane.innerHTML = '<div class="texte-integral">'+escHtml(txt)+'</div>';
  } catch(e) {
    pane.innerHTML = '<p style="font-family:\'Spectral\',serif;font-size:13px;color:#c04040;padding:16px;">Impossible de charger le texte : '+e.message+'</p>';
  }
}

function escHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ─── RENDER ───────────────────────────────────────────────
function renderCard(a, idx) {
  var el = document.createElement('div');
  el.className = 'card';
  el.style.animationDelay = (idx*0.04)+'s';
  var cid = 'c'+idx;

  el.innerHTML =
    '<div class="card-top" onclick="toggleCard(\''+cid+'\',this)">'+
      '<div class="card-left">'+
        '<div class="card-ref">Cass. '+a.chambre+' &nbsp;&middot;&nbsp; Pourvoi n&deg;&nbsp;'+a.numero+'</div>'+
        '<div class="card-title">'+a.titre+'</div>'+
      '</div>'+
      '<div class="card-right">'+a.date+'<br>'+a.chambre+'</div>'+
    '</div>'+
    '<div class="card-badges">'+
      (a.formation?'<span class="badge fs">'+a.formation+'</span>':'')+
      (a.bull?'<span class="badge bull">Bulletin</span>':'')+
    '</div>'+
    '<div class="card-chapeau" onclick="toggleCard(\''+cid+'\',null)">'+a.chapeau+'</div>'+
    '<div class="card-body" id="body-'+cid+'">'+
      '<div class="tabs">'+
        '<div class="tab on" id="tab-som-'+cid+'" onclick="switchTab(\''+cid+'\',\'som\')">Sommaire</div>'+
        '<div class="tab" id="tab-txt-'+cid+'" onclick="switchTab(\''+cid+'\',\'txt\')">Texte int\u00e9gral</div>'+
      '</div>'+
      '<div class="tab-pane on" id="pane-som-'+cid+'">'+
        '<div class="sommaire">'+a.sommaire+'</div>'+
        (a.attendu?'<div class="attendu">'+a.attendu+'</div>':'')+
      '</div>'+
      '<div class="tab-pane" id="pane-texte-'+cid+'">'+
        '<p style="font-family:\'Spectral\',serif;font-size:13px;font-weight:300;color:#8a8a8a;padding:16px 0;">Cliquez sur l\'onglet pour charger le texte int\u00e9gral.</p>'+
      '</div>'+
      '<div class="card-foot">'+
        '<a class="btn-sm btn-outline" href="'+a.url+'" target="_blank">&#8599; Voir sur L\u00e9gifrance</a>'+
        '<button class="btn-sm btn-ghost" onclick="copyRef(this,\''+a.numero+'\')">Copier la r\u00e9f\u00e9rence</button>'+
      '</div>'+
    '</div>';

  el.id = cid;
  el._data = a;
  return el;
}

function toggleCard(cid, topEl) {
  var card = document.getElementById(cid);
  card.classList.toggle('open');
}

function switchTab(cid, tab) {
  ['som','txt'].forEach(function(t){
    document.getElementById('tab-'+t+'-'+cid).className = 'tab'+(t===tab?' on':'');
    document.getElementById('pane-'+t+'-'+cid).className = 'tab-pane'+(t===tab?' on':'');
  });
  if (tab === 'txt') {
    var card = document.getElementById(cid);
    var a = card._data;
    fetchTexte(cid, a._apiId || (isLive() ? null : null));
  }
}

function copyRef(btn, num) {
  navigator.clipboard.writeText('Cass. n\u00b0\u00a0'+num).then(function(){
    btn.textContent = '\u2713 Copi\u00e9';
    setTimeout(function(){ btn.textContent = 'Copier la r\u00e9f\u00e9rence'; }, 1500);
  });
}

// ─── SEARCH ───────────────────────────────────────────────
async function doSearch() {
  var raw = document.getElementById('q').value.trim();
  if (!raw) return;
  var terms = parseTerms(raw);

  var loader = document.getElementById('loader'),
      list   = document.getElementById('list'),
      resBar = document.getElementById('resBar'),
      empty  = document.getElementById('empty'),
      strip  = document.getElementById('demoStrip');

  list.innerHTML = ''; resBar.style.display = 'none';
  empty.classList.remove('on'); loader.classList.add('on'); strip.style.display = 'none';

  var results = [], isDemo = false;
  try {
    if (isLive()) {
      results = await searchAPI(raw);
    } else {
      strip.style.display = 'block';
      await new Promise(function(r){ setTimeout(r, 350); });
      var df = parseInt(document.getElementById('dFrom').value)||0;
      var dt2 = parseInt(document.getElementById('dTo').value)||9999;
      var pool = DEMO.slice();
      if (activeCh && CHMAP[activeCh]) {
        var chN = n(CHMAP[activeCh].split(' ').slice(0,2).join(' '));
        pool = pool.filter(function(a){ return n(a.chambre).includes(chN); });
      }
      if (df||dt2<9999) pool = pool.filter(function(a){ return a.dateY>=df&&a.dateY<=dt2; });
      results = pool.map(function(a){ return Object.assign({},a,{_score:scoreArret(a,terms)}); })
        .filter(function(a){ return a._score>0; })
        .sort(function(a,b){ return b._score-a._score; });
      isDemo = true;
    }
  } catch(err) {
    strip.style.display = 'block';
    strip.textContent = '\u26a0 '+err.message+' \u2014 Mode d\u00e9monstration.';
    results = DEMO.map(function(a){ return Object.assign({},a,{_score:scoreArret(a,terms)}); })
      .filter(function(a){ return a._score>0; }).sort(function(a,b){ return b._score-a._score; });
    isDemo = true;
  }

  loader.classList.remove('on');

  if (!results.length) {
    empty.classList.add('on'); return;
  }

  currentResults = results;
  resBar.style.display = 'flex';
  var label = terms.length > 1
    ? '\u00ab\u00a0'+terms.join('\u00a0\u2022\u00a0')+'\u00a0\u00bb'
    : '\u00ab\u00a0'+raw+'\u00a0\u00bb';
  document.getElementById('resInfo').innerHTML =
    '<strong>'+results.length+'</strong> d\u00e9cision'+(results.length>1?'s':'')+' \u2014 '+label+
    (isDemo?' <span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:#aaa;margin-left:6px;">D\u00c9MO</span>':'');

  renderResults(results);
}

function renderResults(results) {
  var list = document.getElementById('list');
  list.innerHTML = '';
  results.forEach(function(r,i){ list.appendChild(renderCard(r,i)); });
}

function sortResults(mode) {
  var r = currentResults.slice();
  if (mode==='date_desc') r.sort(function(a,b){ return (b.dateY||0)-(a.dateY||0); });
  else if (mode==='date_asc') r.sort(function(a,b){ return (a.dateY||0)-(b.dateY||0); });
  else r.sort(function(a,b){ return (b._score||0)-(a._score||0); });
  renderResults(r);
}
</script>
</body>
</html>
